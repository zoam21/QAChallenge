"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const os_family_1 = __importDefault(require("os-family"));
const which_promise_1 = __importDefault(require("which-promise"));
const lodash_1 = require("lodash");
const fs_exists_promised_1 = __importDefault(require("../utils/fs-exists-promised"));
const exec_1 = require("../utils/exec");
const unquote_1 = __importDefault(require("../utils/unquote"));
const aliases_1 = __importDefault(require("../aliases"));
const MICROSOFT_EDGE_CLASS = 'Microsoft.MicrosoftEdge';
const MICROSOFT_EDGE_KEY_GLOB = `HKCU\\Software\\Classes\\ActivatableClasses\\Package\\${MICROSOFT_EDGE_CLASS}*`;
const BROWSER_COMMANDS_KEY_GLOB = root => `${root}\\Software\\Clients\\StartMenuInternet\\*\\shell\\open\\command`;
const MACOS_GET_BROWSER_LIST_COMMAND = 'ls "/Applications/" | grep -E "Chrome|Firefox|Opera|Safari|Chromium|Edge" | sed -E "s/ /032/"';
const LINE_WRAP = '\r\n';
const DOUBLE_LINE_WRAP = LINE_WRAP + LINE_WRAP;
const REGISTRY_BROWSER_PATH_PROPERTY = '(default)';
const REGISTRY_BROWSER_NAME_PROPERTY = 'PSPath';
const REGISTRY_PROPERTIES_RE = /^(\(default\)|PSPath)\s*:\s*(.*)$/;
const MAX_OUTPUT_WIDTH = 2 ** 31 - 1;
const POWERSHELL_PIPE_SYMBOL = '|';
const GET_REGISTRY_KEY_COMMAND = key => `Get-Item 'Registry::${key}'`;
const GET_BROWSER_PATH_PROPERTY_COMMAND = `Get-ItemProperty -Name '${REGISTRY_BROWSER_PATH_PROPERTY}'`;
const FORMAT_BROWSER_INFO_COMMAND = `Format-List -Property '${REGISTRY_BROWSER_PATH_PROPERTY}','${REGISTRY_BROWSER_NAME_PROPERTY}'`;
const LIMIT_OUTPUT_WIDTH_COMMAND = `Out-String -Width ${MAX_OUTPUT_WIDTH}`;
// NOTE: We have to use Write-Host for compatibility with PowerShell 2.0
const WRITE_HOST_COMMAND = 'Write-Host';
const GET_REGISTRY_BROWSER_PROPERTIES_COMMAND = key => [
    GET_REGISTRY_KEY_COMMAND(key),
    GET_BROWSER_PATH_PROPERTY_COMMAND,
    FORMAT_BROWSER_INFO_COMMAND,
    LIMIT_OUTPUT_WIDTH_COMMAND,
    WRITE_HOST_COMMAND
].join(POWERSHELL_PIPE_SYMBOL);
// Installation info cache
var installationsCache = null;
async function getRegistryKey(regKeyGlob) {
    return exec_1.execPowershell(GET_REGISTRY_KEY_COMMAND(regKeyGlob));
}
async function getRegistryBrowserProperties(regKeyGlob) {
    return exec_1.execPowershell(GET_REGISTRY_BROWSER_PROPERTIES_COMMAND(regKeyGlob));
}
// Find installations for different platforms
async function addInstallation(installations, name, instPath) {
    var fileExists = await fs_exists_promised_1.default(instPath);
    if (fileExists) {
        Object.keys(aliases_1.default).some(alias => {
            var { nameRe, cmd, macOpenCmdTemplate, path } = aliases_1.default[alias];
            if (nameRe.test(name)) {
                installations[alias] = { path: path || instPath, cmd, macOpenCmdTemplate };
                return true;
            }
            return false;
        });
    }
}
async function detectMicrosoftEdgeLegacy() {
    const registryResult = await getRegistryKey(MICROSOFT_EDGE_KEY_GLOB);
    if (registryResult.stdout.includes(MICROSOFT_EDGE_CLASS))
        return aliases_1.default['edge-legacy'];
    return null;
}
async function searchInRegistry(registryRoot) {
    const installations = {};
    const registryResult = await getRegistryBrowserProperties(BROWSER_COMMANDS_KEY_GLOB(registryRoot));
    const data = registryResult.stdout
        .split(DOUBLE_LINE_WRAP)
        .map(block => block
        .split(LINE_WRAP)
        .map(line => line.match(REGISTRY_PROPERTIES_RE))
        .filter(match => !!match)
        .map(match => ({
        [match[1]]: unquote_1.default(match[2])
    })))
        .filter(block => block && block.length)
        .map(block => lodash_1.merge(...block));
    await Promise.all(data.map(record => addInstallation(installations, record[REGISTRY_BROWSER_NAME_PROPERTY], record[REGISTRY_BROWSER_PATH_PROPERTY])));
    return installations;
}
async function findWindowsBrowsers() {
    const machineRegisteredBrowsers = await searchInRegistry('HKEY_LOCAL_MACHINE');
    const userRegisteredBrowsers = await searchInRegistry('HKEY_CURRENT_USER');
    const installations = Object.assign(machineRegisteredBrowsers, userRegisteredBrowsers);
    const edgeLegacy = await detectMicrosoftEdgeLegacy();
    if (edgeLegacy)
        installations['edge-legacy'] = edgeLegacy;
    if (edgeLegacy && !installations['edge'])
        installations['edge'] = edgeLegacy;
    return installations;
}
async function findMacBrowsers() {
    var installations = {};
    // NOTE: replace the space symbol with code, because grep splits strings by space.
    var stdout = await exec_1.exec(MACOS_GET_BROWSER_LIST_COMMAND);
    await Promise.all(stdout
        .split('\n')
        .filter(fileName => !!fileName)
        .map(fileName => {
        // NOTE: restore space
        fileName = fileName.replace(/032/g, ' ');
        var name = fileName.replace(/.app$/, '');
        var path = `/Applications/${fileName}`;
        return addInstallation(installations, name, path);
    }));
    return installations;
}
async function findLinuxBrowsers() {
    var installations = {};
    var aliasCheckingPromises = Object
        .keys(aliases_1.default)
        .map(name => {
        var { linuxBinaries } = aliases_1.default[name];
        if (!linuxBinaries)
            return null;
        var detectionPromises = linuxBinaries
            .map(binary => {
            return which_promise_1.default(binary)
                .then(path => addInstallation(installations, name, path))
                .catch(() => {
                // NOTE: binary not found, just do nothing
                return;
            });
        });
        return Promise.all(detectionPromises);
    });
    await Promise.all(aliasCheckingPromises);
    return installations;
}
async function findBrowsers() {
    if (os_family_1.default.win)
        return await findWindowsBrowsers();
    if (os_family_1.default.mac)
        return await findMacBrowsers();
    if (os_family_1.default.linux)
        return await findLinuxBrowsers();
}
// API
/** @typedef {Object} BrowserInfo
 * @description Object that contains information about the browser installed on the machine.
 * @property {string|undefined} path - The path to the executable file that starts the browser.
 *  Required on MacOS machines. On Windows machines, it is used when the winOpenCmdTemplate property is undefined.
 * @property {string} cmd - Additional command line parameters.
 * @property {string} macOpenCmdTemplate - A [Mustache template](https://github.com/janl/mustache.js#templates)
 *  that provides parameters for launching the browser on a MacOS machine.
 * @property {string|undefined} winOpenCmdTemplate - A [Mustache template](https://github.com/janl/mustache.js#templates)
 *  that provides parameters for launching the browser on a Windows machine.  If undefined, the path to the
 *  executable file specified by the path property is used.
 * @example
 *  {
 *       path: 'C:\\ProgramFiles\\...\\firefox.exe',
 *       cmd: '-new-window',
 *       macOpenCmdTemplate: 'open -a "{{{path}}}" {{{pageUrl}}} --args {{{cmd}}}'
 *  }
 */
/**
 * Returns the list of the {@link BrowserInfo} objects that contain information about the browsers installed on the machine.
 * @function
 * @async
 * @name getInstallations
 * @returns {Object.<string, BrowserInfo>} List of the {@link BrowserInfo} objects
 *   containing information about the browsers installed on the machine.
 * @example
 * {
 *   chrome: {
 *       path: 'C:\\ProgramFiles\\...\\chrome.exe',
 *       cmd: '--new-window',
 *       macOpenCmdTemplate: 'open -n -a "{{{path}}}" --args {{{pageUrl}}} {{{cmd}}}'
 *   },
 *
 *   firefox: {
 *       path: 'C:\\ProgramFiles\\...\\firefox.exe',
 *       cmd: '-new-window',
 *       macOpenCmdTemplate: 'open -a "{{{path}}}" {{{pageUrl}}} --args {{{cmd}}}'
 *   }
 * }
 */
async function default_1() {
    if (!installationsCache)
        installationsCache = await findBrowsers();
    return installationsCache;
}
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWluc3RhbGxhdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXBpL2dldC1pbnN0YWxsYXRpb25zLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsMERBQTJCO0FBQzNCLGtFQUFrQztBQUNsQyxtQ0FBK0I7QUFDL0IscUZBQWlEO0FBQ2pELHdDQUFxRDtBQUNyRCwrREFBdUM7QUFDdkMseURBQWlDO0FBRWpDLE1BQU0sb0JBQW9CLEdBQVEseUJBQXlCLENBQUM7QUFDNUQsTUFBTSx1QkFBdUIsR0FBSyx5REFBeUQsb0JBQW9CLEdBQUcsQ0FBQztBQUNuSCxNQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLGlFQUFpRSxDQUFDO0FBRW5ILE1BQU0sOEJBQThCLEdBQUcsK0ZBQStGLENBQUM7QUFFdkksTUFBTSxTQUFTLEdBQVUsTUFBTSxDQUFDO0FBQ2hDLE1BQU0sZ0JBQWdCLEdBQUcsU0FBUyxHQUFHLFNBQVMsQ0FBQztBQUUvQyxNQUFNLDhCQUE4QixHQUFHLFdBQVcsQ0FBQztBQUNuRCxNQUFNLDhCQUE4QixHQUFHLFFBQVEsQ0FBQztBQUNoRCxNQUFNLHNCQUFzQixHQUFXLG1DQUFtQyxDQUFDO0FBRTNFLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFFckMsTUFBTSxzQkFBc0IsR0FBRyxHQUFHLENBQUM7QUFFbkMsTUFBTSx3QkFBd0IsR0FBWSxHQUFHLENBQUMsRUFBRSxDQUFDLHVCQUF1QixHQUFHLEdBQUcsQ0FBQztBQUMvRSxNQUFNLGlDQUFpQyxHQUFHLDJCQUEyQiw4QkFBOEIsR0FBRyxDQUFDO0FBQ3ZHLE1BQU0sMkJBQTJCLEdBQVMsMEJBQTBCLDhCQUE4QixNQUFNLDhCQUE4QixHQUFHLENBQUM7QUFDMUksTUFBTSwwQkFBMEIsR0FBVSxxQkFBcUIsZ0JBQWdCLEVBQUUsQ0FBQztBQUVsRix3RUFBd0U7QUFDeEUsTUFBTSxrQkFBa0IsR0FBRyxZQUFZLENBQUM7QUFFeEMsTUFBTSx1Q0FBdUMsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDO0lBQ25ELHdCQUF3QixDQUFDLEdBQUcsQ0FBQztJQUM3QixpQ0FBaUM7SUFDakMsMkJBQTJCO0lBQzNCLDBCQUEwQjtJQUMxQixrQkFBa0I7Q0FDckIsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUUvQiwwQkFBMEI7QUFDMUIsSUFBSSxrQkFBa0IsR0FBRyxJQUFJLENBQUM7QUFFOUIsS0FBSyxVQUFVLGNBQWMsQ0FBRSxVQUFVO0lBQ3JDLE9BQU8scUJBQWMsQ0FBQyx3QkFBd0IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0FBQ2hFLENBQUM7QUFFRCxLQUFLLFVBQVUsNEJBQTRCLENBQUUsVUFBVTtJQUNuRCxPQUFPLHFCQUFjLENBQUMsdUNBQXVDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztBQUMvRSxDQUFDO0FBRUQsNkNBQTZDO0FBQzdDLEtBQUssVUFBVSxlQUFlLENBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxRQUFRO0lBQ3pELElBQUksVUFBVSxHQUFHLE1BQU0sNEJBQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUV4QyxJQUFJLFVBQVUsRUFBRTtRQUNaLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUM5QixJQUFJLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxrQkFBa0IsRUFBRSxJQUFJLEVBQUUsR0FBRyxpQkFBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRS9ELElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDbkIsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksSUFBSSxRQUFRLEVBQUUsR0FBRyxFQUFFLGtCQUFrQixFQUFFLENBQUM7Z0JBQzNFLE9BQU8sSUFBSSxDQUFDO2FBQ2Y7WUFFRCxPQUFPLEtBQUssQ0FBQztRQUNqQixDQUFDLENBQUMsQ0FBQztLQUNOO0FBQ0wsQ0FBQztBQUVELEtBQUssVUFBVSx5QkFBeUI7SUFDcEMsTUFBTSxjQUFjLEdBQUcsTUFBTSxjQUFjLENBQUMsdUJBQXVCLENBQUMsQ0FBQztJQUVyRSxJQUFJLGNBQWMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDO1FBQ3BELE9BQU8saUJBQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUVsQyxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDO0FBRUQsS0FBSyxVQUFVLGdCQUFnQixDQUFFLFlBQVk7SUFDekMsTUFBTSxhQUFhLEdBQUksRUFBRSxDQUFDO0lBQzFCLE1BQU0sY0FBYyxHQUFJLE1BQU0sNEJBQTRCLENBQUMseUJBQXlCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztJQUVwRyxNQUFNLElBQUksR0FBRyxjQUFjLENBQUMsTUFBTTtTQUM3QixLQUFLLENBQUMsZ0JBQWdCLENBQUM7U0FDdkIsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSztTQUNkLEtBQUssQ0FBQyxTQUFTLENBQUM7U0FDaEIsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1NBQy9DLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7U0FDeEIsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNYLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsaUJBQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDaEMsQ0FBQyxDQUFDLENBQ047U0FDQSxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQztTQUN0QyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxjQUFLLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBRW5DLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsZUFBZSxDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUMsOEJBQThCLENBQUMsRUFBRSxNQUFNLENBQUMsOEJBQThCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUV0SixPQUFPLGFBQWEsQ0FBQztBQUN6QixDQUFDO0FBRUQsS0FBSyxVQUFVLG1CQUFtQjtJQUM5QixNQUFNLHlCQUF5QixHQUFHLE1BQU0sZ0JBQWdCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUMvRSxNQUFNLHNCQUFzQixHQUFNLE1BQU0sZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUM5RSxNQUFNLGFBQWEsR0FBZSxNQUFNLENBQUMsTUFBTSxDQUFDLHlCQUF5QixFQUFFLHNCQUFzQixDQUFDLENBQUM7SUFDbkcsTUFBTSxVQUFVLEdBQWtCLE1BQU0seUJBQXlCLEVBQUUsQ0FBQztJQUVwRSxJQUFJLFVBQVU7UUFDVixhQUFhLENBQUMsYUFBYSxDQUFDLEdBQUcsVUFBVSxDQUFDO0lBRTlDLElBQUksVUFBVSxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQztRQUNwQyxhQUFhLENBQUMsTUFBTSxDQUFDLEdBQUcsVUFBVSxDQUFDO0lBRXZDLE9BQU8sYUFBYSxDQUFDO0FBQ3pCLENBQUM7QUFFRCxLQUFLLFVBQVUsZUFBZTtJQUMxQixJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUM7SUFFdkIsa0ZBQWtGO0lBQ2xGLElBQUksTUFBTSxHQUFHLE1BQU0sV0FBSSxDQUFDLDhCQUE4QixDQUFDLENBQUM7SUFFeEQsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU07U0FDbkIsS0FBSyxDQUFDLElBQUksQ0FBQztTQUNYLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7U0FDOUIsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1FBQ1osc0JBQXNCO1FBQ3RCLFFBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUV6QyxJQUFJLElBQUksR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN6QyxJQUFJLElBQUksR0FBRyxpQkFBaUIsUUFBUSxFQUFFLENBQUM7UUFFdkMsT0FBTyxlQUFlLENBQUMsYUFBYSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN0RCxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRVIsT0FBTyxhQUFhLENBQUM7QUFDekIsQ0FBQztBQUVELEtBQUssVUFBVSxpQkFBaUI7SUFDNUIsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO0lBRXZCLElBQUkscUJBQXFCLEdBQUcsTUFBTTtTQUM3QixJQUFJLENBQUMsaUJBQU8sQ0FBQztTQUNiLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNSLElBQUksRUFBRSxhQUFhLEVBQUUsR0FBRyxpQkFBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXRDLElBQUksQ0FBQyxhQUFhO1lBQ2QsT0FBTyxJQUFJLENBQUM7UUFFaEIsSUFBSSxpQkFBaUIsR0FBRyxhQUFhO2FBQ2hDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNWLE9BQU8sdUJBQUssQ0FBQyxNQUFNLENBQUM7aUJBQ2YsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsZUFBZSxDQUFDLGFBQWEsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7aUJBQ3hELEtBQUssQ0FBQyxHQUFHLEVBQUU7Z0JBQ1IsMENBQTBDO2dCQUMxQyxPQUFPO1lBQ1gsQ0FBQyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUMsQ0FBQztRQUVQLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQzFDLENBQUMsQ0FBQyxDQUFDO0lBRVAsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFFekMsT0FBTyxhQUFhLENBQUM7QUFDekIsQ0FBQztBQUVELEtBQUssVUFBVSxZQUFZO0lBQ3ZCLElBQUksbUJBQUUsQ0FBQyxHQUFHO1FBQ04sT0FBTyxNQUFNLG1CQUFtQixFQUFFLENBQUM7SUFFdkMsSUFBSSxtQkFBRSxDQUFDLEdBQUc7UUFDTixPQUFPLE1BQU0sZUFBZSxFQUFFLENBQUM7SUFFbkMsSUFBSSxtQkFBRSxDQUFDLEtBQUs7UUFDUixPQUFPLE1BQU0saUJBQWlCLEVBQUUsQ0FBQztBQUN6QyxDQUFDO0FBR0QsTUFBTTtBQUNOOzs7Ozs7Ozs7Ozs7Ozs7O0dBZ0JHO0FBRUg7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXFCRztBQUNZLEtBQUs7SUFDaEIsSUFBSSxDQUFDLGtCQUFrQjtRQUNuQixrQkFBa0IsR0FBRyxNQUFNLFlBQVksRUFBRSxDQUFDO0lBRTlDLE9BQU8sa0JBQWtCLENBQUM7QUFDOUIsQ0FBQztBQUxELDRCQUtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9TIGZyb20gJ29zLWZhbWlseSc7XG5pbXBvcnQgd2hpY2ggZnJvbSAnd2hpY2gtcHJvbWlzZSc7XG5pbXBvcnQgeyBtZXJnZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZXhpc3RzIGZyb20gJy4uL3V0aWxzL2ZzLWV4aXN0cy1wcm9taXNlZCc7XG5pbXBvcnQgeyBleGVjLCBleGVjUG93ZXJzaGVsbCB9IGZyb20gJy4uL3V0aWxzL2V4ZWMnO1xuaW1wb3J0IHVucXVvdGUgZnJvbSAnLi4vdXRpbHMvdW5xdW90ZSc7XG5pbXBvcnQgQUxJQVNFUyBmcm9tICcuLi9hbGlhc2VzJztcblxuY29uc3QgTUlDUk9TT0ZUX0VER0VfQ0xBU1MgICAgICA9ICdNaWNyb3NvZnQuTWljcm9zb2Z0RWRnZSc7XG5jb25zdCBNSUNST1NPRlRfRURHRV9LRVlfR0xPQiAgID0gYEhLQ1VcXFxcU29mdHdhcmVcXFxcQ2xhc3Nlc1xcXFxBY3RpdmF0YWJsZUNsYXNzZXNcXFxcUGFja2FnZVxcXFwke01JQ1JPU09GVF9FREdFX0NMQVNTfSpgO1xuY29uc3QgQlJPV1NFUl9DT01NQU5EU19LRVlfR0xPQiA9IHJvb3QgPT4gYCR7cm9vdH1cXFxcU29mdHdhcmVcXFxcQ2xpZW50c1xcXFxTdGFydE1lbnVJbnRlcm5ldFxcXFwqXFxcXHNoZWxsXFxcXG9wZW5cXFxcY29tbWFuZGA7XG5cbmNvbnN0IE1BQ09TX0dFVF9CUk9XU0VSX0xJU1RfQ09NTUFORCA9ICdscyBcIi9BcHBsaWNhdGlvbnMvXCIgfCBncmVwIC1FIFwiQ2hyb21lfEZpcmVmb3h8T3BlcmF8U2FmYXJpfENocm9taXVtfEVkZ2VcIiB8IHNlZCAtRSBcInMvIC8wMzIvXCInO1xuXG5jb25zdCBMSU5FX1dSQVAgICAgICAgID0gJ1xcclxcbic7XG5jb25zdCBET1VCTEVfTElORV9XUkFQID0gTElORV9XUkFQICsgTElORV9XUkFQO1xuXG5jb25zdCBSRUdJU1RSWV9CUk9XU0VSX1BBVEhfUFJPUEVSVFkgPSAnKGRlZmF1bHQpJztcbmNvbnN0IFJFR0lTVFJZX0JST1dTRVJfTkFNRV9QUk9QRVJUWSA9ICdQU1BhdGgnO1xuY29uc3QgUkVHSVNUUllfUFJPUEVSVElFU19SRSAgICAgICAgID0gL14oXFwoZGVmYXVsdFxcKXxQU1BhdGgpXFxzKjpcXHMqKC4qKSQvO1xuXG5jb25zdCBNQVhfT1VUUFVUX1dJRFRIID0gMiAqKiAzMSAtIDE7XG5cbmNvbnN0IFBPV0VSU0hFTExfUElQRV9TWU1CT0wgPSAnfCc7XG5cbmNvbnN0IEdFVF9SRUdJU1RSWV9LRVlfQ09NTUFORCAgICAgICAgICA9IGtleSA9PiBgR2V0LUl0ZW0gJ1JlZ2lzdHJ5Ojoke2tleX0nYDtcbmNvbnN0IEdFVF9CUk9XU0VSX1BBVEhfUFJPUEVSVFlfQ09NTUFORCA9IGBHZXQtSXRlbVByb3BlcnR5IC1OYW1lICcke1JFR0lTVFJZX0JST1dTRVJfUEFUSF9QUk9QRVJUWX0nYDtcbmNvbnN0IEZPUk1BVF9CUk9XU0VSX0lORk9fQ09NTUFORCAgICAgICA9IGBGb3JtYXQtTGlzdCAtUHJvcGVydHkgJyR7UkVHSVNUUllfQlJPV1NFUl9QQVRIX1BST1BFUlRZfScsJyR7UkVHSVNUUllfQlJPV1NFUl9OQU1FX1BST1BFUlRZfSdgO1xuY29uc3QgTElNSVRfT1VUUFVUX1dJRFRIX0NPTU1BTkQgICAgICAgID0gYE91dC1TdHJpbmcgLVdpZHRoICR7TUFYX09VVFBVVF9XSURUSH1gO1xuXG4vLyBOT1RFOiBXZSBoYXZlIHRvIHVzZSBXcml0ZS1Ib3N0IGZvciBjb21wYXRpYmlsaXR5IHdpdGggUG93ZXJTaGVsbCAyLjBcbmNvbnN0IFdSSVRFX0hPU1RfQ09NTUFORCA9ICdXcml0ZS1Ib3N0JztcblxuY29uc3QgR0VUX1JFR0lTVFJZX0JST1dTRVJfUFJPUEVSVElFU19DT01NQU5EID0ga2V5ID0+IFtcbiAgICBHRVRfUkVHSVNUUllfS0VZX0NPTU1BTkQoa2V5KSxcbiAgICBHRVRfQlJPV1NFUl9QQVRIX1BST1BFUlRZX0NPTU1BTkQsXG4gICAgRk9STUFUX0JST1dTRVJfSU5GT19DT01NQU5ELFxuICAgIExJTUlUX09VVFBVVF9XSURUSF9DT01NQU5ELFxuICAgIFdSSVRFX0hPU1RfQ09NTUFORFxuXS5qb2luKFBPV0VSU0hFTExfUElQRV9TWU1CT0wpO1xuXG4vLyBJbnN0YWxsYXRpb24gaW5mbyBjYWNoZVxudmFyIGluc3RhbGxhdGlvbnNDYWNoZSA9IG51bGw7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlZ2lzdHJ5S2V5IChyZWdLZXlHbG9iKSB7XG4gICAgcmV0dXJuIGV4ZWNQb3dlcnNoZWxsKEdFVF9SRUdJU1RSWV9LRVlfQ09NTUFORChyZWdLZXlHbG9iKSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlZ2lzdHJ5QnJvd3NlclByb3BlcnRpZXMgKHJlZ0tleUdsb2IpIHtcbiAgICByZXR1cm4gZXhlY1Bvd2Vyc2hlbGwoR0VUX1JFR0lTVFJZX0JST1dTRVJfUFJPUEVSVElFU19DT01NQU5EKHJlZ0tleUdsb2IpKTtcbn1cblxuLy8gRmluZCBpbnN0YWxsYXRpb25zIGZvciBkaWZmZXJlbnQgcGxhdGZvcm1zXG5hc3luYyBmdW5jdGlvbiBhZGRJbnN0YWxsYXRpb24gKGluc3RhbGxhdGlvbnMsIG5hbWUsIGluc3RQYXRoKSB7XG4gICAgdmFyIGZpbGVFeGlzdHMgPSBhd2FpdCBleGlzdHMoaW5zdFBhdGgpO1xuXG4gICAgaWYgKGZpbGVFeGlzdHMpIHtcbiAgICAgICAgT2JqZWN0LmtleXMoQUxJQVNFUykuc29tZShhbGlhcyA9PiB7XG4gICAgICAgICAgICB2YXIgeyBuYW1lUmUsIGNtZCwgbWFjT3BlbkNtZFRlbXBsYXRlLCBwYXRoIH0gPSBBTElBU0VTW2FsaWFzXTtcblxuICAgICAgICAgICAgaWYgKG5hbWVSZS50ZXN0KG5hbWUpKSB7XG4gICAgICAgICAgICAgICAgaW5zdGFsbGF0aW9uc1thbGlhc10gPSB7IHBhdGg6IHBhdGggfHwgaW5zdFBhdGgsIGNtZCwgbWFjT3BlbkNtZFRlbXBsYXRlIH07XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBkZXRlY3RNaWNyb3NvZnRFZGdlTGVnYWN5ICgpIHtcbiAgICBjb25zdCByZWdpc3RyeVJlc3VsdCA9IGF3YWl0IGdldFJlZ2lzdHJ5S2V5KE1JQ1JPU09GVF9FREdFX0tFWV9HTE9CKTtcblxuICAgIGlmIChyZWdpc3RyeVJlc3VsdC5zdGRvdXQuaW5jbHVkZXMoTUlDUk9TT0ZUX0VER0VfQ0xBU1MpKVxuICAgICAgICByZXR1cm4gQUxJQVNFU1snZWRnZS1sZWdhY3knXTtcblxuICAgIHJldHVybiBudWxsO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZWFyY2hJblJlZ2lzdHJ5IChyZWdpc3RyeVJvb3QpIHtcbiAgICBjb25zdCBpbnN0YWxsYXRpb25zICA9IHt9O1xuICAgIGNvbnN0IHJlZ2lzdHJ5UmVzdWx0ID0gIGF3YWl0IGdldFJlZ2lzdHJ5QnJvd3NlclByb3BlcnRpZXMoQlJPV1NFUl9DT01NQU5EU19LRVlfR0xPQihyZWdpc3RyeVJvb3QpKTtcblxuICAgIGNvbnN0IGRhdGEgPSByZWdpc3RyeVJlc3VsdC5zdGRvdXRcbiAgICAgICAgLnNwbGl0KERPVUJMRV9MSU5FX1dSQVApXG4gICAgICAgIC5tYXAoYmxvY2sgPT4gYmxvY2tcbiAgICAgICAgICAgIC5zcGxpdChMSU5FX1dSQVApXG4gICAgICAgICAgICAubWFwKGxpbmUgPT4gbGluZS5tYXRjaChSRUdJU1RSWV9QUk9QRVJUSUVTX1JFKSlcbiAgICAgICAgICAgIC5maWx0ZXIobWF0Y2ggPT4gISFtYXRjaClcbiAgICAgICAgICAgIC5tYXAobWF0Y2ggPT4gKHtcbiAgICAgICAgICAgICAgICBbbWF0Y2hbMV1dOiB1bnF1b3RlKG1hdGNoWzJdKVxuICAgICAgICAgICAgfSkpXG4gICAgICAgIClcbiAgICAgICAgLmZpbHRlcihibG9jayA9PiBibG9jayAmJiBibG9jay5sZW5ndGgpXG4gICAgICAgIC5tYXAoYmxvY2sgPT4gbWVyZ2UoLi4uYmxvY2spKTtcblxuICAgIGF3YWl0IFByb21pc2UuYWxsKGRhdGEubWFwKHJlY29yZCA9PiBhZGRJbnN0YWxsYXRpb24oaW5zdGFsbGF0aW9ucywgcmVjb3JkW1JFR0lTVFJZX0JST1dTRVJfTkFNRV9QUk9QRVJUWV0sIHJlY29yZFtSRUdJU1RSWV9CUk9XU0VSX1BBVEhfUFJPUEVSVFldKSkpO1xuXG4gICAgcmV0dXJuIGluc3RhbGxhdGlvbnM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpbmRXaW5kb3dzQnJvd3NlcnMgKCkge1xuICAgIGNvbnN0IG1hY2hpbmVSZWdpc3RlcmVkQnJvd3NlcnMgPSBhd2FpdCBzZWFyY2hJblJlZ2lzdHJ5KCdIS0VZX0xPQ0FMX01BQ0hJTkUnKTtcbiAgICBjb25zdCB1c2VyUmVnaXN0ZXJlZEJyb3dzZXJzICAgID0gYXdhaXQgc2VhcmNoSW5SZWdpc3RyeSgnSEtFWV9DVVJSRU5UX1VTRVInKTtcbiAgICBjb25zdCBpbnN0YWxsYXRpb25zICAgICAgICAgICAgID0gT2JqZWN0LmFzc2lnbihtYWNoaW5lUmVnaXN0ZXJlZEJyb3dzZXJzLCB1c2VyUmVnaXN0ZXJlZEJyb3dzZXJzKTtcbiAgICBjb25zdCBlZGdlTGVnYWN5ICAgICAgICAgICAgICAgID0gYXdhaXQgZGV0ZWN0TWljcm9zb2Z0RWRnZUxlZ2FjeSgpO1xuXG4gICAgaWYgKGVkZ2VMZWdhY3kpXG4gICAgICAgIGluc3RhbGxhdGlvbnNbJ2VkZ2UtbGVnYWN5J10gPSBlZGdlTGVnYWN5O1xuXG4gICAgaWYgKGVkZ2VMZWdhY3kgJiYgIWluc3RhbGxhdGlvbnNbJ2VkZ2UnXSlcbiAgICAgICAgaW5zdGFsbGF0aW9uc1snZWRnZSddID0gZWRnZUxlZ2FjeTtcblxuICAgIHJldHVybiBpbnN0YWxsYXRpb25zO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5kTWFjQnJvd3NlcnMgKCkge1xuICAgIHZhciBpbnN0YWxsYXRpb25zID0ge307XG5cbiAgICAvLyBOT1RFOiByZXBsYWNlIHRoZSBzcGFjZSBzeW1ib2wgd2l0aCBjb2RlLCBiZWNhdXNlIGdyZXAgc3BsaXRzIHN0cmluZ3MgYnkgc3BhY2UuXG4gICAgdmFyIHN0ZG91dCA9IGF3YWl0IGV4ZWMoTUFDT1NfR0VUX0JST1dTRVJfTElTVF9DT01NQU5EKTtcblxuICAgIGF3YWl0IFByb21pc2UuYWxsKHN0ZG91dFxuICAgICAgICAuc3BsaXQoJ1xcbicpXG4gICAgICAgIC5maWx0ZXIoZmlsZU5hbWUgPT4gISFmaWxlTmFtZSlcbiAgICAgICAgLm1hcChmaWxlTmFtZSA9PiB7XG4gICAgICAgICAgICAvLyBOT1RFOiByZXN0b3JlIHNwYWNlXG4gICAgICAgICAgICBmaWxlTmFtZSA9IGZpbGVOYW1lLnJlcGxhY2UoLzAzMi9nLCAnICcpO1xuXG4gICAgICAgICAgICB2YXIgbmFtZSA9IGZpbGVOYW1lLnJlcGxhY2UoLy5hcHAkLywgJycpO1xuICAgICAgICAgICAgdmFyIHBhdGggPSBgL0FwcGxpY2F0aW9ucy8ke2ZpbGVOYW1lfWA7XG5cbiAgICAgICAgICAgIHJldHVybiBhZGRJbnN0YWxsYXRpb24oaW5zdGFsbGF0aW9ucywgbmFtZSwgcGF0aCk7XG4gICAgICAgIH0pKTtcblxuICAgIHJldHVybiBpbnN0YWxsYXRpb25zO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5kTGludXhCcm93c2VycyAoKSB7XG4gICAgdmFyIGluc3RhbGxhdGlvbnMgPSB7fTtcblxuICAgIHZhciBhbGlhc0NoZWNraW5nUHJvbWlzZXMgPSBPYmplY3RcbiAgICAgICAgLmtleXMoQUxJQVNFUylcbiAgICAgICAgLm1hcChuYW1lID0+IHtcbiAgICAgICAgICAgIHZhciB7IGxpbnV4QmluYXJpZXMgfSA9IEFMSUFTRVNbbmFtZV07XG5cbiAgICAgICAgICAgIGlmICghbGludXhCaW5hcmllcylcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcblxuICAgICAgICAgICAgdmFyIGRldGVjdGlvblByb21pc2VzID0gbGludXhCaW5hcmllc1xuICAgICAgICAgICAgICAgIC5tYXAoYmluYXJ5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoaWNoKGJpbmFyeSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKHBhdGggPT4gYWRkSW5zdGFsbGF0aW9uKGluc3RhbGxhdGlvbnMsIG5hbWUsIHBhdGgpKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOT1RFOiBiaW5hcnkgbm90IGZvdW5kLCBqdXN0IGRvIG5vdGhpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGRldGVjdGlvblByb21pc2VzKTtcbiAgICAgICAgfSk7XG5cbiAgICBhd2FpdCBQcm9taXNlLmFsbChhbGlhc0NoZWNraW5nUHJvbWlzZXMpO1xuXG4gICAgcmV0dXJuIGluc3RhbGxhdGlvbnM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpbmRCcm93c2VycyAoKSB7XG4gICAgaWYgKE9TLndpbilcbiAgICAgICAgcmV0dXJuIGF3YWl0IGZpbmRXaW5kb3dzQnJvd3NlcnMoKTtcblxuICAgIGlmIChPUy5tYWMpXG4gICAgICAgIHJldHVybiBhd2FpdCBmaW5kTWFjQnJvd3NlcnMoKTtcblxuICAgIGlmIChPUy5saW51eClcbiAgICAgICAgcmV0dXJuIGF3YWl0IGZpbmRMaW51eEJyb3dzZXJzKCk7XG59XG5cblxuLy8gQVBJXG4vKiogQHR5cGVkZWYge09iamVjdH0gQnJvd3NlckluZm9cbiAqIEBkZXNjcmlwdGlvbiBPYmplY3QgdGhhdCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgYnJvd3NlciBpbnN0YWxsZWQgb24gdGhlIG1hY2hpbmUuXG4gKiBAcHJvcGVydHkge3N0cmluZ3x1bmRlZmluZWR9IHBhdGggLSBUaGUgcGF0aCB0byB0aGUgZXhlY3V0YWJsZSBmaWxlIHRoYXQgc3RhcnRzIHRoZSBicm93c2VyLlxuICogIFJlcXVpcmVkIG9uIE1hY09TIG1hY2hpbmVzLiBPbiBXaW5kb3dzIG1hY2hpbmVzLCBpdCBpcyB1c2VkIHdoZW4gdGhlIHdpbk9wZW5DbWRUZW1wbGF0ZSBwcm9wZXJ0eSBpcyB1bmRlZmluZWQuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gY21kIC0gQWRkaXRpb25hbCBjb21tYW5kIGxpbmUgcGFyYW1ldGVycy5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBtYWNPcGVuQ21kVGVtcGxhdGUgLSBBIFtNdXN0YWNoZSB0ZW1wbGF0ZV0oaHR0cHM6Ly9naXRodWIuY29tL2phbmwvbXVzdGFjaGUuanMjdGVtcGxhdGVzKVxuICogIHRoYXQgcHJvdmlkZXMgcGFyYW1ldGVycyBmb3IgbGF1bmNoaW5nIHRoZSBicm93c2VyIG9uIGEgTWFjT1MgbWFjaGluZS5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfHVuZGVmaW5lZH0gd2luT3BlbkNtZFRlbXBsYXRlIC0gQSBbTXVzdGFjaGUgdGVtcGxhdGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9qYW5sL211c3RhY2hlLmpzI3RlbXBsYXRlcylcbiAqICB0aGF0IHByb3ZpZGVzIHBhcmFtZXRlcnMgZm9yIGxhdW5jaGluZyB0aGUgYnJvd3NlciBvbiBhIFdpbmRvd3MgbWFjaGluZS4gIElmIHVuZGVmaW5lZCwgdGhlIHBhdGggdG8gdGhlXG4gKiAgZXhlY3V0YWJsZSBmaWxlIHNwZWNpZmllZCBieSB0aGUgcGF0aCBwcm9wZXJ0eSBpcyB1c2VkLlxuICogQGV4YW1wbGVcbiAqICB7XG4gKiAgICAgICBwYXRoOiAnQzpcXFxcUHJvZ3JhbUZpbGVzXFxcXC4uLlxcXFxmaXJlZm94LmV4ZScsXG4gKiAgICAgICBjbWQ6ICctbmV3LXdpbmRvdycsXG4gKiAgICAgICBtYWNPcGVuQ21kVGVtcGxhdGU6ICdvcGVuIC1hIFwie3t7cGF0aH19fVwiIHt7e3BhZ2VVcmx9fX0gLS1hcmdzIHt7e2NtZH19fSdcbiAqICB9XG4gKi9cblxuLyoqXG4gKiBSZXR1cm5zIHRoZSBsaXN0IG9mIHRoZSB7QGxpbmsgQnJvd3NlckluZm99IG9iamVjdHMgdGhhdCBjb250YWluIGluZm9ybWF0aW9uIGFib3V0IHRoZSBicm93c2VycyBpbnN0YWxsZWQgb24gdGhlIG1hY2hpbmUuXG4gKiBAZnVuY3Rpb25cbiAqIEBhc3luY1xuICogQG5hbWUgZ2V0SW5zdGFsbGF0aW9uc1xuICogQHJldHVybnMge09iamVjdC48c3RyaW5nLCBCcm93c2VySW5mbz59IExpc3Qgb2YgdGhlIHtAbGluayBCcm93c2VySW5mb30gb2JqZWN0c1xuICogICBjb250YWluaW5nIGluZm9ybWF0aW9uIGFib3V0IHRoZSBicm93c2VycyBpbnN0YWxsZWQgb24gdGhlIG1hY2hpbmUuXG4gKiBAZXhhbXBsZVxuICoge1xuICogICBjaHJvbWU6IHtcbiAqICAgICAgIHBhdGg6ICdDOlxcXFxQcm9ncmFtRmlsZXNcXFxcLi4uXFxcXGNocm9tZS5leGUnLFxuICogICAgICAgY21kOiAnLS1uZXctd2luZG93JyxcbiAqICAgICAgIG1hY09wZW5DbWRUZW1wbGF0ZTogJ29wZW4gLW4gLWEgXCJ7e3twYXRofX19XCIgLS1hcmdzIHt7e3BhZ2VVcmx9fX0ge3t7Y21kfX19J1xuICogICB9LFxuICpcbiAqICAgZmlyZWZveDoge1xuICogICAgICAgcGF0aDogJ0M6XFxcXFByb2dyYW1GaWxlc1xcXFwuLi5cXFxcZmlyZWZveC5leGUnLFxuICogICAgICAgY21kOiAnLW5ldy13aW5kb3cnLFxuICogICAgICAgbWFjT3BlbkNtZFRlbXBsYXRlOiAnb3BlbiAtYSBcInt7e3BhdGh9fX1cIiB7e3twYWdlVXJsfX19IC0tYXJncyB7e3tjbWR9fX0nXG4gKiAgIH1cbiAqIH1cbiAqL1xuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGlmICghaW5zdGFsbGF0aW9uc0NhY2hlKVxuICAgICAgICBpbnN0YWxsYXRpb25zQ2FjaGUgPSBhd2FpdCBmaW5kQnJvd3NlcnMoKTtcblxuICAgIHJldHVybiBpbnN0YWxsYXRpb25zQ2FjaGU7XG59XG4iXX0=